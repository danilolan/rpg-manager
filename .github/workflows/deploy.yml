name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cat > .env.production << EOF
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          APP_PORT=${{ secrets.APP_PORT }}
          NODE_ENV=production
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public
          EOF

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: ".env.production"
          target: "/tmp/rpg-manager-deploy"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e  # Exit immediately if a command exits with a non-zero status
            set -o pipefail  # Return value of a pipeline is the status of the last command to exit with a non-zero status
            
            # Ensure webapps directory exists
            mkdir -p /home/${{ secrets.SERVER_USER }}/webapps
            
            # Navigate to webapps directory
            cd /home/${{ secrets.SERVER_USER }}/webapps || exit 1
            
            # Clone or pull the repository
            if [ ! -d rpg-manager ]; then
              echo "Repository not found, cloning..."
              git clone https://github.com/${{ github.repository }}.git rpg-manager
            fi
            
            # Navigate to project directory
            cd /home/${{ secrets.SERVER_USER }}/webapps/rpg-manager || exit 1
            
            # Pull latest changes
            git pull origin main
            
            # Move environment file from temp
            mv /tmp/rpg-manager-deploy/.env.production .env.production
            chmod 600 .env.production
            rm -rf /tmp/rpg-manager-deploy
            
            # Build and deploy with docker-compose
            echo "Stopping existing containers..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml down || true
            
            echo "Building Docker images..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml build --no-cache || {
              echo "❌ Docker build failed!"
              exit 1
            }
            
            echo "Starting containers..."
            docker-compose --env-file .env.production -f docker-compose.prod.yml up -d || {
              echo "❌ Failed to start containers!"
              exit 1
            }
            
            # Verify containers are running
            echo "Checking container status..."
            if ! docker-compose --env-file .env.production -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "❌ Containers are not running properly!"
              docker-compose --env-file .env.production -f docker-compose.prod.yml ps
              docker-compose --env-file .env.production -f docker-compose.prod.yml logs
              exit 1
            fi
            
            # Clean up old images
            docker image prune -af --filter "until=24h"
            
            # Show final status
            echo "✅ Deployment successful!"
            docker-compose --env-file .env.production -f docker-compose.prod.yml ps

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi

